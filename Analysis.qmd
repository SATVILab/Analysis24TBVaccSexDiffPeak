---
title: Analyse peak response
format:
  html:
    embed-resources: true
---

```{r}
#| include: false
library(ggplot2)
library(tibble)
library(tidyr)
library(betareg)
library(statmod)
library(numDeriv)
library(betareg)
library(car)
library(lmtest)
library(dplyr)
theme_cowplot_bg <- function(font_size = 14) {
  theme_cowplot(font_size = font_size) +
  theme(
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  )
}
fn_vec <- list.files("R", pattern = "\\.R$", full.names = TRUE)
for (i in seq_along(fn_vec)) {
  source(fn_vec[[i]])
}
```


## Data prep

Here we load the data:

```{r}
library(DataTidy24TBVaccSexDiff)
data("data_tidy_vacc_freq")
```

Now we calculate the summed response and the profile response, and then extract the peak response:

```{r}
data_tidy_vacc_summed <- data_tidy_vacc_freq |>
  vacc_calc_response_summed("response") |>
  vacc_calc_vaccine_induced_response("response") |>
  vacc_set_neg_to_zero("response") |>
  vacc_extract_peak() |>
  dplyr::filter(subset == "cd4")
data_tidy_vacc_summed

data_tidy_vacc_profile <- data_tidy_vacc_freq |>
  vacc_calc_response_profile("response") |>
  vacc_calc_vaccine_induced_response("response") |>
  vacc_set_neg_to_zero("response") |>
  vacc_extract_peak() |>
  dplyr::filter(subset == "cd4")
data_tidy_vacc_profile

data_tidy_vacc_raw_profile <- data_tidy_vacc_freq |>
  vacc_calc_response_profile(cn_resp = "response")|>
  vacc_extract_peak()

data_tidy_vacc_vi_profile <- data_tidy_vacc_freq |>
  vacc_calc_vaccine_induced_response(cn_resp = "response") |>
  vacc_calc_response_profile(cn_resp = "response")|>
  vacc_extract_peak()

data_tidy_vacc_raw_fds_prop <- data_tidy_vacc_freq |>
  vacc_calc_fds_prop(cn_resp = "response")|>
  vacc_extract_peak() |>
  dplyr::filter(subset == "cd4")

data_tidy_vacc_vi_fds_prop <-  data_tidy_vacc_freq |>
  vacc_calc_vaccine_induced_response(cn_resp = "response") |>
  vacc_calc_fds_prop(cn_resp = "response") |>
  vacc_extract_peak() |>
  dplyr::filter(subset == "cd4")
```

## Data exploration

### Sample sizes

```{r}
knitr::kable(data_tidy_vacc_summed |>
  dplyr::mutate(vaccine = stringr::str_to_upper(vaccine)) %>%
  dplyr::group_by(vaccine, sex, timepoint, infxn) |>
  dplyr::summarise(count = dplyr::n(), .groups = "drop") |>
  dplyr::rename(Vaccine = vaccine, Sex = sex,Timepoint = timepoint,Infxn = infxn,Count = count)|>
  dplyr::arrange(Vaccine, Infxn, Sex))
```

## Analysis

### Data exploration

```{r}
#install.packages("cowplot")
library(cowplot)
```

Table of data:
```{r}
knitr::kable(data_tidy_vacc_freq|>dplyr::filter(ptid=='bcg-040-21' & subset=='cd4'& timepoint=="70"))
knitr::kable(data_tidy_vacc_summed|>dplyr::filter(ptid=='bcg-040-21'))
```


Boxplot of summed response by infection status:

```{r}
boxplot1 <- ggplot(data_tidy_vacc_summed, aes(x = infxn, y = response, fill = infxn)) +
  geom_boxplot() +
  facet_wrap(~ vaccine)+
  labs(title = "Summed Response by Infection Status", x = "Infection Status", y = "Summed Response") +
  theme_cowplot_bg()
ggsave("Boxplot of Summed Response by Infection Status.png", boxplot1)
```

Boxplot of summed response by sex:

```{r}
boxplot2 <- ggplot(data_tidy_vacc_summed, aes(x = sex, y = response, fill = sex)) +
  geom_boxplot() +
  facet_wrap(~ vaccine)+
  labs(title = "Summed Response by Sex", x = "Sex", y = "Summed Response") +
  theme_cowplot_bg()
ggsave("Boxplot of Summed Response by Sex.png", boxplot2)
```

Boxplot of summed response by sex and infection status:

```{r}
boxplot3 <- ggplot(data_tidy_vacc_summed, aes(x = sex, y = response, fill = sex)) +
  geom_boxplot() +
  facet_grid(vaccine ~ infxn,labeller = labeller(vaccine = toupper)) +
  labs(title = "Summed Response by Sex and Infection Status", x = "Sex", y = "Summed Response") +
  theme_cowplot_bg()+
  theme(
    axis.text.x = element_blank(),        # Remove x-axis text
    axis.ticks.x = element_blank(),       # Remove x-axis ticks
    panel.grid.major.x = element_blank(), # Optionally remove major x-axis grid lines
    panel.grid.minor.x = element_blank(), # Optionally remove minor x-axis grid lines
    legend.position = 'bottom',
     strip.text = element_text(size = 12,  # Adjust facet label size
    face = "bold"),
    axis.text.y = element_text(size = 13,   # Adjust y-axis title size
    face = "bold"),
    legend.text = element_text(size = 12) ) + # Set y-axis title font style             # Place legend at the bottom                   
    background_grid(major='y')+
  guides(fill = guide_legend(title = NULL))

# Save the plot
ggsave("Boxplot of Summed Response by Sex and Infection Status.png",boxplot3)
```

### Analysis of summed response

#### Mann-Whitney

Perform Mann-Whitney Tests :

```{r}
Mann_Whitney_tests <- list(
  infxn = wilcox.test(response ~ infxn, data = data_tidy_vacc_summed),
  sex = wilcox.test(response ~ sex, data = data_tidy_vacc_summed)
)

mw_tbl_summed <- purrr::map_df(unique(data_tidy_vacc_summed$infxn), function(infxn) {
  data_tidy_vacc_sub <- data_tidy_vacc_summed |>
    dplyr::filter(infxn == .env$infxn)
  purrr::map_df(unique(data_tidy_vacc_sub$vaccine), function(vaccine) {
    data_tidy_vacc_sub_sub <- data_tidy_vacc_sub |>
      dplyr::filter(vaccine == .env$vaccine)
    # browser()
    resp_vec_male <- data_tidy_vacc_sub_sub |>
      dplyr::filter(sex == "male") |>
      dplyr::pull(response)
    resp_vec_female <- data_tidy_vacc_sub_sub |>
      dplyr::filter(sex == "female") |>
      dplyr::pull(response)
    p_val <- wilcox.test(resp_vec_male, resp_vec_female)$p.value
    tibble::tibble(
      infxn = infxn, vaccine = vaccine, p_val = p_val
    )
  })
})

mw_tbl_summed <- mw_tbl_summed |>
  dplyr::group_by(infxn) |>
  dplyr::mutate(q_val = p.adjust(p_val, method = "holm")) |>
  dplyr::ungroup()
mw_tbl_summed
```

#### Kruskal-Wallis

This repeats the Mann-Whitney tests.

Kruskal-Wallis Test:

```{r}
library(tidyr)
library(dplyr)
library(purrr)

vacc_inf_sex <- with(data_tidy_vacc_summed, interaction(vaccine, infxn, sex))
test <- kruskal.test(response ~ vacc_inf_sex, data = data_tidy_vacc_summed)
test

results <- data_tidy_vacc_summed |>
  group_by(vaccine, infxn) |>
  nest() |>
  mutate(kruskal_test = map(data, ~ kruskal.test(response_sqrt ~ sex, data = .x)),
         p_value = map_dbl(kruskal_test, "p.value"))

results |>
  select(vaccine, infxn, p_value)
```

#### Beta regression

##### Data transformation

Obtain the square root of the summed response:

```{r}
data_tidy_vacc_summed <- data_tidy_vacc_summed |>
  dplyr::mutate(response_proportion = sqrt(response / 100))
```

Boxplot of square root transformed summed responses by sex and infection status:

```{r}
boxplot4 <- ggplot(data_tidy_vacc_summed, aes(x = sex, y = response_proportion, fill = sex)) +
  geom_boxplot() +
  facet_grid(vaccine ~ infxn) +
  labs(title = "Square Root of Summed Response by Sex and Infection Status", x = "Sex", y = "Square Root of Summed Response") +
  theme_cowplot_bg() 

# Save the plot
ggsave("Boxplot of Square Root Summed Response by Sex and Infection Status.png", boxplot4)
```

Skewness of Responses:

```{r}
histogram1 <- ggplot(data_tidy_vacc_summed, aes(x = response_proportion)) +
  geom_histogram(binwidth = 0.05, fill = 'blue', color = 'black', alpha = 0.7) +
  facet_wrap(~ vaccine) +
  labs(title = "Histogram of Responses by Vaccine",
       x = "Square Root of Summed Response",
       y = "Frequency") +
  theme_cowplot_bg()
ggsave('Histogram of skewness of square root of summed responses by vaccine.png',histogram1)     
```

##### Simple regression

Fit Beta Regression Models of Uninfected to examine the effect of sex on response for each vaccine, for each vaccine individually:

```{r}
data_tidy_vacc_summed_uninf <- data_tidy_vacc_summed |>  
    dplyr::filter(infxn == "uninfected") 

beta_h1_uninf <- betareg( 
  response_proportion ~ sex, data = data_tidy_vacc_summed_uninf |>
    dplyr::filter(vaccine == "h1")) 

beta_h56_uninf <- betareg(response_proportion ~ sex,data = data_tidy_vacc_summed_uninf |> 
   dplyr::filter(vaccine == "h56")) 

beta_mva85a_uninf<-betareg(response_proportion ~ sex,data =data_tidy_vacc_summed_uninf |> 
   dplyr::filter(vaccine == "mva85a"))

beta_bcg_uninf <- betareg(response_proportion ~ sex, data =data_tidy_vacc_summed_uninf |> 
   dplyr::filter(vaccine == "bcg"))  

beta_m72_uninf <- betareg(response_proportion ~ sex, data =data_tidy_vacc_summed_uninf |> 
   dplyr::filter(vaccine == "m72"))  

#extract p-values
p_vec <- c(
  summary(beta_h1_uninf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_h56_uninf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_mva85a_uninf)$coefficients$mean[-1, "Pr(>|z|)"],
  summary(beta_bcg_uninf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_m72_uninf)$coefficients$mean[-1, "Pr(>|z|)"]
)
p_vec

#Holm's Procedure
p.adjust(p_vec, method = "holm")
```

##### Multiple regression

Fit Beta Regression Model of Uninfected and Infected to examine the effect of interaction between sex and vaccine on response :

```{r}
beta_uninfected <- betareg(
  response_proportion ~ sex*vaccine,
  data = data_tidy_vacc_summed |> dplyr::filter(infxn == "uninfected")
)
summary(beta_uninfected)
```

Fit Beta Regression Model of Infected to examine the effect of interaction between sex and vaccine on response :

```{r}
beta_infected <- betareg(
  response_proportion ~ sex*vaccine,
  data = data_tidy_vacc_summed |> dplyr::filter(infxn == "infected")
  )

beta_infected <- betareg(
  response_proportion ~ vaccine*sex,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn =="infected") |>
    dplyr::mutate(vaccine = factor(.data$vaccine, levels = c("h56", "h1", "mva85a", "m72"))))

summary(beta_infected)                            

ggsave('Table of estimates of effect sizes and CI.png',plot_infected2,width = 10, height = 6)
```

###### Residual plots

Create Residual Plots for the beta regression models of Uninfected and Infected:

```{r}
#residual plot for beta_uninfected model

data_uninfected <- data_tidy_vacc_summed %>%
  dplyr::filter(infxn == "uninfected") %>%
  dplyr::mutate(predicted = predict(beta_uninfected, type = "response"),
         residuals = residuals(beta_uninfected, type = "pearson"))

beta_residual1 <- ggplot(data_uninfected, aes(x = predicted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residual Plot for Beta Regression Model of Uninfected",
       x = "Predicted Values",
       y = "Residuals") +
  theme_cowplot_bg()
ggsave('Residual Plot for Beta Regression Model of Uninfected.png',beta_residual1)

#residual plot for beta_infected model

data_infected <- data_tidy_vacc_summed |>
  dplyr::filter(infxn == "infected") |>
  dplyr::mutate(predicted = predict(beta_infected, type = "response"),
         residuals = response_proportion - predicted)

beta_residual2 <- ggplot(data_infected, aes(x = predicted, y = residuals)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residual Plot for Beta Regression Model of Infected",
       x = "Predicted Values",
       y = "Residuals") +
  theme_cowplot_bg()
ggsave('Residual Plot for Beta Regression Model of Infected.png',beta_residual2)

# Plotting the residuals for infected
png("residuals_infected.png")
plot(beta_infected$residuals, main = "Residuals of the infected Beta Regression Model",ylab='Residuals')
abline(h= 0, col= "red", lwd= 2)
dev.off()
```

Exploration of Residuals for uninfected Individuals:

```{r}
# Add residuals to the dataset
data_uninfected_residuals <-  data_tidy_vacc_summed %>%
  dplyr::filter(infxn == "uninfected") %>%
  dplyr::mutate(residuals = beta_uninfected$residuals)

# Summarize residuals by vaccine
residual_summary <- data_uninfected_residuals |> 
  dplyr::group_by(vaccine) |> 
  dplyr::summarise(mean_residual = mean(residuals, na.rm = TRUE),
                   sd_residual = sd(residuals, na.rm = TRUE),
                   min_residual = min(residuals, na.rm = TRUE),
                   max_residual = max(residuals, na.rm = TRUE))

# Boxplot of residuals by vaccine
residual_vacc_uninf <- ggplot(data_uninfected_residuals, aes(x = vaccine, y = residuals, fill= vaccine))+
  geom_boxplot() +
  labs(y = "Residuals", x = "Vaccine") +
  scale_x_discrete(labels = toupper) +
  scale_fill_manual(
    values = c("h56" = "red", "h1" = "blue", "mva85a" = "purple", "m72" = "green", "bcg" = "orange")) +
  theme_cowplot_bg()
ggsave('Residual by Vaccine for Uninfected Individuals.png',residual_vacc_uninf)

# Q-Q plot for the residuals of the beta regression model
png("QQ_Uninf_peak.png")
qqnorm(beta_uninfected$residuals, main="")
qqline(beta_uninfected$residuals, col = "red", lwd = 2)
dev.off()
```

Exploration of Residuals for infected Individuals:

```{r}
# Add residuals to the dataset
data_infected_residuals <-  data_tidy_vacc_summed %>%
  dplyr::filter(infxn == "infected") %>%
  dplyr::mutate(residuals = beta_infected$residuals)

# Summarize residuals by vaccine
residual_summary <- data_infected_residuals |> 
  dplyr::group_by(vaccine) |> 
  dplyr::summarise(mean_residual = mean(residuals, na.rm = TRUE),
                   sd_residual = sd(residuals, na.rm = TRUE),
                   min_residual = min(residuals, na.rm = TRUE),
                   max_residual = max(residuals, na.rm = TRUE))

# Boxplot of residuals by vaccine
residual_vacc_inf <- ggplot(data_infected_residuals, aes(x = vaccine, y = residuals, fill= vaccine)) +
  geom_boxplot() +
  labs(y = "Residuals", x = "Vaccine") +
  scale_x_discrete(labels = toupper) +
  scale_fill_manual(
    values = c("h56" = "red", "h1" = "blue", "mva85a" = "purple", "m72" = "green")) +
  theme_cowplot_bg()
ggsave('Residual by Vaccine for Infected Individuals.png',residual_vacc_inf)

# Q-Q plot for the residuals of the beta regression model
png("QQ_Inf_peak.png")
qqnorm(beta_infected$residuals, main="")
qqline(beta_infected$residuals, col = "red", lwd = 2)
dev.off()
```

Fit Beta Regression Models of Infected to examine the effect of sex on response for each vaccine :

```{r}
data_tidy_vacc_summed_inf <- data_tidy_vacc_summed |>  
    dplyr::filter(infxn == "infected") 

beta_h1_inf <- betareg(
  response_proportion ~ sex, 
  data = data_tidy_vacc_summed_inf |>
    dplyr::filter(vaccine == "h1")
  ) 

beta_h56_inf <- betareg( response_proportion ~ sex,  data = data_tidy_vacc_summed_inf |> 
   dplyr::filter(vaccine == "h56")) 

beta_mva85a_inf <- betareg( response_proportion ~ sex,data = data_tidy_vacc_summed_inf |> 
   dplyr::filter(vaccine == "mva85a"))
beta_m72_inf <- betareg( response_proportion ~ sex,data = data_tidy_vacc_summed_inf |> 
   dplyr::filter(vaccine == "m72"))

#extract p-values
p_vec <- c(
  summary(beta_h1_inf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_h56_inf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_mva85a_inf)$coefficients$mu[-1, "Pr(>|z|)"],
  summary(beta_m72_inf)$coefficients$mean[-1, "Pr(>|z|)"]
)
p_vec

#Holm's Procedure
p.adjust(p_vec, method = "holm")
```

##### Global test for sex effect for at least one vaccine

For Infected Individuals:

```{r}
full_model_inf <- betareg(
  response_proportion ~ sex*vaccine,
  data = data_tidy_vacc_summed |> 
    dplyr::filter(infxn =="infected")
)
null_model_inf <- betareg(
  response_proportion ~ vaccine,
  data = data_tidy_vacc_summed|>
    dplyr::filter(infxn == "infected")
)

summary_full <- summary(full_model_inf)
summary_null <- summary(null_model_inf)

# Wald test
Wald_inf <- car::linearHypothesis(
  full_model_inf,
  c("sexmale = 0",
  "sexmale:vaccineh56 = 0",
  "sexmale:vaccinemva85a = 0",
  "sexmale:vaccinem72 = 0"
  )
)

# likelihood ratio test
likelihood_inf <- lmtest::lrtest(full_model_inf, null_model_inf)

# extract p-values
p_vec_global <- c(Wald_inf$`Pr(>Chisq)`[2],likelihood_inf$`Pr(>Chisq)`[2])

inf_tbl_global <- tibble(
  Test = c("Wald", "Likelihood Ratio"),
  `P-value` = p_vec_global,
  `Q-value` = p.adjust(p_vec_global, method = "holm")
)
```

For Uninfected Individuals:

```{r}
full_model_uninf <- betareg(response_proportion ~ vaccine*sex, 
                    data = data_tidy_vacc_summed|>
                 dplyr::filter(infxn == "uninfected")|>
    dplyr::mutate(vaccine = factor(.data$vaccine, levels = c("h56", "h1", "mva85a","bcg", "m72"))))
â€‹
null_model_uninf <- betareg(response_proportion ~ vaccine,
                   data = data_tidy_vacc_summed|>
                dplyr::filter(infxn == "uninfected"))

summary_full_uninf <- summary(full_model_uninf)
summary_null_uninf <- summary(null_model_uninf)

#extract p-values
p_vec <- c(mean(summary_full_uninf$coefficients$mu[-1, "Pr(>|z|)"]), 
           mean(summary_null_uninf$coefficients$mu[-1, "Pr(>|z|)"]))
p_vec

#Holm's Correction
p.adjust(p_vec, method = "holm")

# Wald test
Wald_uninf <- car::linearHypothesis(full_model_uninf, c("sexmale = 0", "vaccineh1:sexmale = 0","vaccinebcg:sexmale = 0", "vaccinemva85a:sexmale = 0", "vaccinem72:sexmale = 0"))

# likelihood ratio test
likelihood_uninf <- lmtest::lrtest(full_model_uninf, null_model_uninf)

# extract p-values
p_vec <- c(Wald_uninf$`Pr(>Chisq)`[2],likelihood_uninf$`Pr(>Chisq)`[2])
p_vec

# Holm's Correction
p.adjust(p_vec, method = "holm")
```

##### Getting per-vaccine sex effect estimates and inference

###### Infected

```{r}
full_model_inf_h56 <- betareg(
  response_proportion ~ sex * vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn =="infected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("h56", "h1", "mva85a", "m72")))
  )
est_h56 <- summary(full_model_inf_h56)$coefficients[[1]]["sexmale", "Estimate"]
p_val_h56 <- summary(full_model_inf_h56)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_h56 <- confint(full_model_inf_h56)[2, c("2.5 %", "97.5 %")]
h56_row <- tibble(
  Vaccine = "H56",
  Estimate = est_h56,
  `95% CI Lower` = ci_h56[1],
  `95% CI Upper` = ci_h56[2],
  `P-value` = p_val_h56
)

# mva85a
full_model_inf_mva85a <- betareg(
  response_proportion ~ sex*vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn =="infected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("mva85a", "h56", "h1", "m72"))
    )
  )
est_mva85a <- summary(full_model_inf_mva85a)$coefficients[[1]]["sexmale", "Estimate"]
p_val_mva85a <- summary(full_model_inf_mva85a)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_mva85a <- confint(full_model_inf_mva85a)[2, c("2.5 %", "97.5 %")]
mva85a_row <- tibble(
  Vaccine = "MVA85A",
  Estimate = est_mva85a,
  `95% CI Lower` = ci_mva85a[1],
  `95% CI Upper` = ci_mva85a[2],
  `P-value` = p_val_mva85a
)

# h1
full_model_inf_h1 <- betareg(
  response_proportion ~ sex*vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn =="infected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("h1", "mva85a", "h56", "m72"))
    )
  )
est_h1 <- summary(full_model_inf_h1)$coefficients[[1]]["sexmale", "Estimate"]
p_val_h1 <- summary(full_model_inf_h1)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_h1 <- confint(full_model_inf_h1)[2, c("2.5 %", "97.5 %")]
h1_row <- tibble(
  Vaccine = "H1",
  Estimate = est_h1,
  `95% CI Lower` = ci_h1[1],
  `95% CI Upper` = ci_h1[2],
  `P-value` = p_val_h1
)

full_model_inf_m72 <- betareg(
  response_proportion ~ sex*vaccine,
  data = data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "infected") |>
    dplyr::mutate(
      vaccine = factor(.data$vaccine, levels = c("m72", "h1", "mva85a", "h56"))
    )
  )
est_m72 <- summary(full_model_inf_m72)$coefficients[[1]]["sexmale", "Estimate"]
p_val_m72 <- summary(full_model_inf_m72)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_m72 <- confint(full_model_inf_m72)[2, c("2.5 %", "97.5 %")]
m72_row <- tibble(
  Vaccine = "M72",
  Estimate = est_m72,
  `95% CI Lower` = ci_m72[1],
  `95% CI Upper` = ci_m72[2],
  `P-value` = p_val_m72
)

inf_tbl_inf <- bind_rows(h56_row, mva85a_row, h1_row, m72_row)
inf_tbl_inf <- inf_tbl_inf |> 
  dplyr::mutate(`Q-value` = p.adjust(`P-value`, method = "holm")) |>
  dplyr::select(Vaccine, Estimate, `P-value`, `Q-value`, `95% CI Lower`, `95% CI Upper`)

inf_tbl_inf <- inf_tbl_inf |>
  dplyr::mutate(
    `P-value` = ifelse(`P-value` < 0.001, "<0.001", round(`P-value`, 3))
  )

# Plot with p-values
p_inf <- ggplot(
  inf_tbl_inf,
  aes(
    x = Vaccine,
    y = Estimate,
    ymin = `95% CI Lower`,
    ymax = `95% CI Upper`,
    color = Vaccine
  )
) +
  theme_cowplot_bg() +
  cowplot::background_grid(major = "y") + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_pointrange() +
  labs(x = "Vaccine", y = "Sex effect") +
  geom_errorbar(aes(ymin = `95% CI Lower`, ymax = `95% CI Upper`), width = 0.1) +
  scale_color_manual(
    values = c("H56" = "red", "H1" = "blue", "MVA85A" = "purple", "M72" = "green")
  ) +
  scale_y_continuous(limits = c(NA, 0.8)) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(size = 20),  # Increase x-axis label size
    axis.title.y = element_text(size = 20),   # Increase y-axis label size
    axis.text.x = element_text(size = 19),   # Adjust x-axis tick label size
    axis.text.y = element_text(size = 19)  
  ) +
  # Add p-value text labels
  geom_text(
    aes(label = `P-value`, y =  `95% CI Upper`+0.04), # Adjust the y position for better placement
    vjust = -0.5,
    size = 6,
    color = "black"
  )

path_fig_inf <- "Plot of estimates of effect sizes and CI infected.pdf"
ggsave(
  path_fig_inf,
  p_inf,
  width = 10,
  height = 6
)
```

###### Uninfected

```{r}
# h56
full_model_uninf_h56 <- betareg(
  response_proportion ~ sex * vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "uninfected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("h56", "h1", "mva85a", "m72", "bcg")))
)
est_h56_uninf <- summary(full_model_uninf_h56)$coefficients[[1]]["sexmale", "Estimate"]
p_val_h56_uninf <- summary(full_model_uninf_h56)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_h56_uninf <- confint(full_model_uninf_h56)[2, c("2.5 %", "97.5 %")]
h56_row_uninf <- tibble(
  Vaccine = "H56",
  Estimate = est_h56_uninf,
  `95% CI Lower` = ci_h56_uninf[1],
  `95% CI Upper` = ci_h56_uninf[2],
  `P-value` = p_val_h56_uninf
)

# mva85a
full_model_uninf_mva85a <- betareg(
  response_proportion ~ sex * vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "uninfected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("mva85a", "h56", "h1", "m72", "bcg"))
    )
)
est_mva85a_uninf <- summary(full_model_uninf_mva85a)$coefficients[[1]]["sexmale", "Estimate"]
p_val_mva85a_uninf <- summary(full_model_uninf_mva85a)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_mva85a_uninf <- confint(full_model_uninf_mva85a)[2, c("2.5 %", "97.5 %")]
mva85a_row_uninf <- tibble(
  Vaccine = "MVA85A",
  Estimate = est_mva85a_uninf,
  `95% CI Lower` = ci_mva85a_uninf[1],
  `95% CI Upper` = ci_mva85a_uninf[2],
  `P-value` = p_val_mva85a_uninf
)

# h1
full_model_uninf_h1 <- betareg(
  response_proportion ~ sex * vaccine,
  data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "uninfected") |>
    dplyr::mutate(vaccine = factor(
      .data$vaccine, levels = c("h1", "mva85a", "h56", "m72", "bcg"))
    )
)
est_h1_uninf <- summary(full_model_uninf_h1)$coefficients[[1]]["sexmale", "Estimate"]
p_val_h1_uninf <- summary(full_model_uninf_h1)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_h1_uninf <- confint(full_model_uninf_h1)[2, c("2.5 %", "97.5 %")]
h1_row_uninf <- tibble(
  Vaccine = "H1",
  Estimate = est_h1_uninf,
  `95% CI Lower` = ci_h1_uninf[1],
  `95% CI Upper` = ci_h1_uninf[2],
  `P-value` = p_val_h1_uninf
)

# m72
full_model_uninf_m72 <- betareg(
  response_proportion ~ sex * vaccine,
  data = data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "uninfected") |>
    dplyr::mutate(
      vaccine = factor(.data$vaccine, levels = c("m72", "h1", "mva85a", "h56", "bcg"))
    )
)
est_m72_uninf <- summary(full_model_uninf_m72)$coefficients[[1]]["sexmale", "Estimate"]
p_val_m72_uninf <- summary(full_model_uninf_m72)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_m72_uninf <- confint(full_model_uninf_m72)[2, c("2.5 %", "97.5 %")]
m72_row_uninf <- tibble(
  Vaccine = "M72",
  Estimate = est_m72_uninf,
  `95% CI Lower` = ci_m72_uninf[1],
  `95% CI Upper` = ci_m72_uninf[2],
  `P-value` = p_val_m72_uninf
)

# bcg
full_model_uninf_bcg <- betareg(
  response_proportion ~ sex * vaccine,
  data = data_tidy_vacc_summed |> 
    dplyr::filter(infxn == "uninfected") |>
    dplyr::mutate(
      vaccine = factor(.data$vaccine, levels = c("bcg", "h1", "mva85a", "h56", "m72"))
    )
)
est_bcg_uninf <- summary(full_model_uninf_bcg)$coefficients[[1]]["sexmale", "Estimate"]
p_val_bcg_uninf <- summary(full_model_uninf_bcg)$coefficients[[1]]["sexmale", "Pr(>|z|)"]
ci_bcg_uninf <- confint(full_model_uninf_bcg)[2, c("2.5 %", "97.5 %")]
bcg_row_uninf <- tibble(
  Vaccine = "BCG",
  Estimate = est_bcg_uninf,
  `95% CI Lower` = ci_bcg_uninf[1],
  `95% CI Upper` = ci_bcg_uninf[2],
  `P-value` = p_val_bcg_uninf
)

# Combine and adjust p-values for uninfected individuals
inf_tbl_uninf <- bind_rows(h56_row_uninf, mva85a_row_uninf, h1_row_uninf, m72_row_uninf, bcg_row_uninf)
inf_tbl_uninf <- inf_tbl_uninf |> 
  dplyr::mutate(`Q-value` = p.adjust(`P-value`, method = "holm")) |>
  dplyr::select(Vaccine, Estimate, `P-value`, `Q-value`, `95% CI Lower`, `95% CI Upper`)

inf_tbl_uninf <- inf_tbl_uninf |>
  dplyr::mutate(
    `P-value` = ifelse(`P-value` < 0.001, "<0.001", round(`P-value`, 3))
  )

# Plot with p-values
p_uninf <- ggplot(
  inf_tbl_uninf,
  aes(
    x = Vaccine,
    y = Estimate,
    ymin = `95% CI Lower`,
    ymax = `95% CI Upper`,
    color = Vaccine
  )
) +
  theme_cowplot_bg() +
  cowplot::background_grid(major = "y") + 
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  geom_pointrange() +
  labs(x = "Vaccine", y = "Sex effect") +
  geom_errorbar(aes(ymin = `95% CI Lower`, ymax = `95% CI Upper`), width = 0.1) +
  scale_color_manual(
    values = c("H56" = "red", "H1" = "blue", "MVA85A" = "purple", "M72" = "green", "BCG" = "orange")
  ) +
  scale_y_continuous(limits = c(NA, 1.5)) +
  theme(
    legend.position = "none",
    axis.title.x = element_text(size = 20),  # Increase x-axis label size
    axis.title.y = element_text(size = 20),   # Increase y-axis label size
    axis.text.x = element_text(size = 19),   # Adjust x-axis tick label size
    axis.text.y = element_text(size = 19)  
  ) +
  # Add p-value text labels
  geom_text(
    aes(label = `P-value`, y = `95% CI Upper`+ 0.04), # Adjust the y position for better placement
    vjust = -0.5,
    size = 6,
    color = "black"
  )

path_fig_uninf <- "Plot of estimates of effect sizes and CI uninfected.pdf"
ggsave(
  path_fig_uninf,
  p_uninf,
  width = 10,
  height = 6
)
```

## Response Profile

Boxplot of Response by Sex and Infection Status 

```{r}
boxplot1 <- ggplot(data_tidy_vacc_profile, aes(x = sex, y = response, fill = sex)) +
  geom_boxplot() +
  facet_grid(vaccine + infxn ~ cyt_combn, scales = "free") +
  labs(title = "Response by Sex and Infection Status for each Cytokine Combination",
       x = "Sex",
       y = "Response") +
  theme_cowplot_bg() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))    

ggsave('Response by Sex and Infection Status for each CYtokine Combination.png',boxplot1)  


 #subset boxplot filtering 2 vaccines
selected_vaccines <- c('h1', 'mva85a')

# Filter the dataset
filtered_data <- data_tidy_vacc_profile %>%
  dplyr::filter(vaccine %in% selected_vaccines)

boxplot2 <- ggplot(filtered_data, aes(x = sex, y = response, fill = sex)) +
  geom_boxplot() +
  facet_grid(vaccine + infxn ~ cyt_combn, scales = "free") +
  labs(title = "Response by Sex and Infection Status for each Cytokine Combination",
       x = "Sex",
       y = "Response") +
  theme_cowplot_bg() +
  theme(axis.text.x = element_blank(),        # Remove x-axis text
    axis.ticks.x = element_blank(),
    legend.position = 'bottom')+   
  background_grid(major='y')+
  guides(fill = guide_legend(title = NULL))
#theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
ggsave('Response by Sex and Infection Status for each CYtokine Combination.png',boxplot2)  
 
```

PCA Biplot

```{r}
#create a wide format where each cytokine combination is a separate column
profile_wide <- data_tidy_vacc_profile |>
  tidyr::pivot_wider(names_from = cyt_combn, values_from = response)

# Select only the cytokine combination columns for PCA
cytokine_cols <- colnames(profile_wide)[grepl("\\+", colnames(profile_wide))]
pca_result <- prcomp(profile_wide[, cytokine_cols], scale. = TRUE)  

# combine PCA results with the original metadata
pca_data <- as.data.frame(pca_result$x) |>
  dplyr::bind_cols(profile_wide |>
  dplyr::select(vaccine, sex, infxn))

# extract PCA loadings
loadings <- as.data.frame(pca_result$rotation[, 1:2]) # Take only the first two PCs
loadings$cyt_combn <- rownames(loadings) # Add cytokine combination names

# scaling factor for arrows
arrow_scale <- 8.5  

# scale PCA loadings for arrows
scaled_loadings <- loadings |>
  dplyr::mutate(PC1 = PC1 * arrow_scale,
         PC2 = PC2 * arrow_scale)

pca_var <- pca_result$sdev^2
pca_var_explained <- pca_var / sum(pca_var)
pc1_var <- scales::percent(pca_var_explained[1])
pc2_var <- scales::percent(pca_var_explained[2])
```

Plot the PCA Biplot:

```{r}
pca_plot1 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = vaccine, shape = sex)) +
  geom_point(size = 3) +
  facet_wrap(~ infxn) +
  labs(title = "PCA Biplot", x = "PC1", y = "PC2") + 
  geom_segment(data = scaled_loadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.3, "cm")), color = "red", inherit.aes = FALSE) +
  geom_text(data = scaled_loadings, aes(x = PC1, y = PC2, label = cyt_combn), nudge_x = 1.5, nudge_y = 0.4, vjust = 1, hjust = 1, color = "red", inherit.aes = FALSE) +
  theme_cowplot_bg()  
ggsave('PCA_Biplot.png', pca_plot1, width = 12, height = 6)
```

PCA biplot with mean positions shown for each vaccine sex combo:
```{r}
# calculate mean positions for each vaccine and sex combination
mean_positions <- pca_data %>%
  dplyr::group_by(vaccine, sex,infxn) %>%
  dplyr::summarize(PC1 = mean(PC1), PC2 = mean(PC2))

mean_positions <- mean_positions %>%
  dplyr::mutate(combo = paste(vaccine, sex, sep = "-"))

pca_plot2 <- ggplot(pca_data|>dplyr::filter(infxn=='infected'), aes(x = PC1, y = PC2, color = vaccine, shape = sex)) +
  labs(title = "PCA Biplot with Mean Positions", 
       x = paste0("PC1 (", pc1_var, ")"), 
       y = paste0("PC2 (", pc2_var, ")")) +
  geom_segment(data = scaled_loadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.3, "cm")), color = "black", inherit.aes = FALSE) +
  geom_text(data = scaled_loadings, aes(x = PC1, y = PC2, label = cyt_combn), 
            nudge_x = 1.5, nudge_y = 0.4, vjust = 1, hjust = 1, color = "black", 
            inherit.aes = FALSE) +
  geom_point(size = 3) +          
  geom_point(data = mean_positions, aes(x = PC1, y = PC2, color = vaccine), 
             shape=1, fill=NA, size = 4, stroke=1.5) +
  ggrepel::geom_text_repel(data = mean_positions, aes(x = PC1, y = PC2, label = combo), 
            nudge_x = 1, nudge_y = 0.5, vjust = 1, hjust = 1, color = "black") +
  theme_cowplot_bg()+ 
  theme(axis.text.x = element_blank(),        # Remove x-axis text
    axis.ticks.x = element_blank())

ggsave('PCA Biplot_mean_positions.png', pca_plot2,width =10, height=6)   
```

PCA biplot with ellipses:
```{r}
pca_plot3 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = vaccine)) +
  geom_point(aes(shape = sex), size = 3) +
  facet_wrap(~ infxn) +
  geom_segment(data = scaled_loadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.5, "cm")), color = "black", linewidth = 0.8, inherit.aes = FALSE) +
  stat_ellipse(aes(fill = vaccine, color = vaccine), geom = "polygon", alpha = 0.1, size = 3.0) +
  ggrepel::geom_text_repel(data = scaled_loadings, aes(x = PC1, y = PC2, label = cyt_combn), nudge_x = 1.5, nudge_y = 0.4, color = "black", inherit.aes = FALSE,segment.color = NA) +
  
  labs(title = "PCA Biplot of Response Profiles", x = "PC1", y = "PC2") + 
  theme_cowplot_bg() +
  theme(legend.position = "right")

ggsave('PCA_Biplot_ellipses.png', pca_plot3, width = 12, height = 6)
```

PCA Biplot with ellipses for each sex-vaccine combination
```{r}
# Create a new column combining sex and vaccine
pca_data <- pca_data %>%
  dplyr::mutate(sex_vaccine = paste(sex, vaccine, sep = "-"))

# define a custom color palette
custom_colors <- c("red", "green", "orange", "darkblue", "brown", "cyan", "purple", "pink")

pca_plot4 <- ggplot(pca_data, aes(x = PC1, y = PC2, color = sex_vaccine)) +
  geom_point(size = 3) +
  facet_wrap(~ infxn) +
  geom_segment(data = scaled_loadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
               arrow = arrow(length = unit(0.5, "cm")), color = "black", linewidth = 0.8, inherit.aes = FALSE) +
  stat_ellipse(aes(fill = sex_vaccine, color = sex_vaccine), geom = "polygon", alpha = 0, linewidth = 2.5) +
  ggrepel::geom_text_repel(data = scaled_loadings, aes(x = PC1, y = PC2, label = cyt_combn), 
                           nudge_x = 1.5, nudge_y = 0.4, color = "black", inherit.aes = FALSE, segment.color = NA) +
  scale_color_manual(values = custom_colors) +  # Apply custom colors
  scale_fill_manual(values = custom_colors) +  # Apply custom colors for fill
  labs(title = "PCA Biplot of Response Profiles", x = "PC1", y = "PC2") + 
  theme_cowplot_bg() +
  theme(legend.position = "right")

ggsave('PCA_biplot_ellipses_vaccine_sex.png', pca_plot4, width = 12, height = 6)
```

Analysis of Response Profile:

Transform response to lie between 0 and 1 using proportions:
```{r}
data_tidy_vacc_profile <- data_tidy_vacc_profile |>
  dplyr::mutate(response_proportion = sqrt(response / 100) + 1e-6)
```

Identify individuals for which the sum of absolute changes from pre-vaccination(vaccine-induced summed response) was 0.02 or more:
```{r}
participant_ids <- data_tidy_vacc_summed %>%
  filter(response >= 0.02) %>%
  pull(ptid)
```

Fit beta regression model for infected individuals with interaction term
```{r}
library(betareg)
library(statmod)
library(numDeriv)

full_model_inf1 <- betareg(response_proportion ~ sex * vaccine * cyt_combn, data = data_tidy_vacc_profile|>
                  dplyr::filter(ptid %in% participant_ids)|>
                  dplyr::filter(infxn =="infected"))

summary(full_model_inf1)

library(purrr)

# Split the dataset by cytokine combination
cytokine_splits <- data_tidy_vacc_profile %>%
  filter(ptid %in% participant_ids)|>
  filter(infxn == "infected") %>%
  split(.$cyt_combn)

# Fit beta regression model for each cytokine combination
beta_models_inf1 <- map(cytokine_splits, function(data) {
  betareg(response_proportion ~ sex * vaccine, data = data)
})
beta_models_inf1
```

Fit the models excluding the mva85a and h56 vaccines due to small sample sizes

```{r}
full_model_inf2 <- betareg(response_proportion ~ sex * vaccine * cyt_combn, data = data_tidy_vacc_profile|>
                            dplyr::filter(ptid %in% participant_ids)|>
                            dplyr::filter(infxn =="infected"))|>
                            filter(!vaccine %in% c("mva85a", "h56"))

summary(full_model_inf2)

cytokine_splits <- data_tidy_vacc_profile %>%
  filter(ptid %in% participant_ids) %>%
  filter(infxn == "infected") %>%
  filter(!vaccine %in% c("mva85a", "h56")) %>%  # Exclude specific vaccines
  split(.$cyt_combn)

# Fit beta regression model for each cytokine combination
beta_models2 <- map(cytokine_splits, function(data) {
  betareg(response_proportion ~ sex * vaccine, data = data)
})
beta_models2

```


Fit beta regression model for uninfected individuals with interaction term
```{r}
full_model_uninf1 <- betareg(response_proportion ~ sex * vaccine * cyt_combn, data = data_tidy_vacc_profile|>
                  dplyr::filter(ptid %in% participant_ids)|>
                  dplyr::filter(infxn =="uninfected"))

summary(full_model_uninf1)

# Split the dataset by cytokine combination
cytokine_splits <- data_tidy_vacc_profile %>%
  filter(ptid %in% participant_ids)|>
  filter(infxn == "uninfected") %>%
  split(.$cyt_combn)

# Fit beta regression model for each cytokine combination
beta_models_uninf1 <- map(cytokine_splits, function(data) {
  betareg(response_proportion ~ sex * vaccine, data = data)
})
beta_models_uninf1
```